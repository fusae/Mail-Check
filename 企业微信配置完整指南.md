# 企业微信配置完整指南

## 📋 前置准备

- ✅ 企业微信管理员账号
- ✅ 腾讯云服务器（IP: 43.129.17.66）
- ✅ 代码已部署到服务器

---

## 🚀 配置步骤

### 第一步：创建企业微信应用

#### 1.1 登录企业微信后台

访问：https://work.weixin.qq.com

使用企业管理员账号登录。

#### 1.2 创建应用

1. 点击顶部菜单 **「应用管理」**
2. 选择 **「应用」**
3. 点击 **「创建应用」**
4. 选择 **「自建应用」**

#### 1.3 填写应用信息

```
应用名称: 舆情监控助手
应用简介: AI舆情监控和反馈系统
应用Logo: 上传图标（可选）
可见范围: 选择需要接收通知的群组/成员
```

点击 **「创建」**

#### 1.4 记录应用信息

创建完成后，记录以下信息：

```
AgentId: 123456           # 应用的AgentID
Secret: xxx-xxx-xxx       # 应用的Secret
```

---

### 第二步：获取企业ID

1. 在企业微信管理后台
2. 点击右上角 **「企业信息」**
3. 记录 **企业ID（CorpId）**

```
CorpId: ww1234567890abcdef  # 企业ID
```

---

### 第三步：配置接收消息

#### 3.1 进入应用详情

找到刚才创建的 **「舆情监控助手」** 应用，点击进入。

#### 3.2 配置接收消息

找到 **「接收消息」** 配置项，点击进入。

#### 3.3 填写回调URL

```
URL: https://43.129.17.66:5001/wechat/callback
```

**注意：** 服务器需要先启动Webhook服务器（后面会说如何启动）

#### 3.4 生成Token和EncodingAESKey

点击 **「随机获取」** 按钮，系统会自动生成：

```
Token: abc123                    # 验证Token
EncodingAESKey: base64_key_here  # 加密密钥
```

记录这两个值。

#### 3.5 保存配置

点击 **「保存」**，系统会自动验证URL是否可访问。

**如果验证失败：**
1. 检查服务器端口是否开放（5001）
2. 检查Webhook服务器是否启动
3. 检查URL是否正确
4. 查看服务器日志：`tail -f logs/webhook.log`

---

### 第四步：开放服务器端口

#### 4.1 开放防火墙端口

在服务器上执行：

```bash
cd /root/mail_check
./start_webhook.sh
```

脚本会自动：
- 检查防火墙类型
- 开放5001端口
- 启动Webhook服务器

#### 4.2 腾讯云安全组配置

如果你的服务器是腾讯云，还需要：

1. 登录腾讯云控制台
2. 云服务器 → 安全组
3. 找到你的安全组，点击 **「配置规则」**
4. 添加入站规则：
   - 协议：TCP
   - 端口：5001
   - 来源：0.0.0.0/0
5. 保存

---

### 第五步：修改配置文件

#### 5.1 填写企业微信应用信息

编辑 `config/config.yaml`：

```yaml
wechat_work:
  # 企业微信应用配置
  corp_id: "ww1234567890abcdef"        # 填写你的企业ID
  agent_id: "123456"                    # 填写你的AgentId
  secret: "xxx-xxx-xxx"                # 填写你的Secret
  token: "abc123"                        # 填写Token
  encoding_aes_key: "base64_key_here"   # 填写EncodingAESKey
  to_user: "@all"                       # 接收人，@all表示所有人
  to_party: ""                           # 部门ID（可选）
  to_tag: ""                              # 标签ID（可选）
  enable_confirm_button: false            # 是否启用"确认负面"按钮

  # 群机器人配置（备用）
  webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=42ef2694-b71f-425c-b530-8652d41ec92c"
```

#### 5.2 配置说明

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `corp_id` | 企业ID | ww1234567890abcdef |
| `agent_id` | 应用ID | 123456 |
| `secret` | 应用密钥 | xxx-xxx-xxx |
| `token` | 验证Token | abc123 |
| `encoding_aes_key` | 加密密钥 | base64_key_here |
| `to_user` | 接收人 | @all |
| `enable_confirm_button` | 启用确认按钮 | false |

---

### 第六步：启动Webhook服务器

#### 6.1 启动服务器

```bash
cd /root/mail_check
./start_webhook.sh
```

#### 6.2 验证启动成功

如果启动成功，会看到：

```
==================================
  ✓ Webhook服务器启动成功
==================================

PID: 12345
日志: logs/webhook.log

访问地址:
  http://43.129.17.66:5001/wechat/callback

管理命令:
  停止服务: ./stop_webhook.sh
  查看日志: tail -f logs/webhook.log
  查看状态: ps -p 12345

==================================
```

#### 6.3 查看日志

```bash
tail -f logs/webhook.log
```

如果看到以下信息，说明启动成功：

```
[INFO] 反馈数据库初始化完成
[INFO] 企业微信Webhook服务器启动中...
[INFO] 访问地址: https://43.129.17.66:5001/wechat/callback
```

---

### 第七步：验证企业微信配置

#### 7.1 保存企业微信配置

回到企业微信管理后台：

1. 应用管理 → 「舆情监控助手」
2. 接收消息 → 点击 **「保存」**

#### 7.2 查看验证结果

如果配置正确，会显示：

```
验证成功
```

如果配置错误，会显示：

```
验证失败
```

#### 7.3 处理验证失败

如果验证失败，检查：

1. **服务器是否启动**
   ```bash
   ps aux | grep wechat_webhook
   ```

2. **端口是否开放**
   ```bash
   netstat -tlnp | grep 5001
   ```

3. **URL是否正确**
   - 检查URL是否填写正确
   - 检查是否有拼写错误

4. **查看服务器日志**
   ```bash
   tail -f logs/webhook.log
   ```

---

### 第八步：测试通知功能

#### 8.1 测试消息发送

```bash
cd /root/mail_check
source venv/bin/activate
python3 -c "
import sys
sys.path.insert(0, 'src')
from wechat_api import WeChatWorkAPI
import yaml

with open('config/config.yaml', 'r') as f:
    config = yaml.safe_load(f)

wechat = WeChatWorkAPI(config['wechat_work'])
result = wechat.send_text('@all', '企业微信配置测试！')
print(result)
"
```

如果成功，会看到：

```json
{
  "errcode": 0,
  "errmsg": "ok",
  "msgid": 1234567890
}
```

#### 8.2 测试Webhook回调

```bash
curl "http://43.129.17.66:5001/wechat/callback?echostr=test"
```

如果Webhook服务器正常运行，会返回加密的字符串。

---

## 🧪 测试完整流程

### 测试1：触发负面舆情

```bash
cd /root/mail_check
source venv/bin/activate
python3 src/main.py
```

等待AI发现负面舆情，发送企业微信通知。

### 测试2：接收通知消息

在企业微信中查看是否收到通知，格式如下：

```
### ⚠️ 发现医院负面舆情

> **医院：** 东莞市第九人民医院
> **来源：** 抖音
> **AI判断：** 医疗隐私泄露，严重程度: high
> **内容：** 医院的病历在网络流传，引起患者不满...

---
> 💡 **反馈方式：**
> - 点击下方按钮
> - 或直接回复消息
```

### 测试3：点击按钮反馈

点击通知中的 **「误判舆情」** 按钮。

检查服务器日志：

```bash
tail -f logs/webhook.log
```

应该看到：

```
[INFO] 收到事件: click
[INFO] 事件键: false_positive_xxx
[INFO] 删除负面舆情记录
[INFO] 保存反馈成功
[INFO] 回复用户: ✅ 收到您的反馈
```

### 测试4：文本回复反馈

在企业微信中回复：

```
误报，这是正常的医疗新闻
```

检查服务器日志，应该看到：

```
[INFO] 收到文本消息
[INFO] 用户回复: 误报，这是正常的医疗新闻
[INFO] 解析反馈: 误报（false_positive）
[INFO] 提取规则候选: ["医疗新闻"]
[INFO] 保存反馈成功
[INFO] 保存规则成功
[INFO] 回复用户: ✅ 已收到反馈并记录
```

---

## 🔧 常见问题

### 问题1：URL验证失败

**可能原因：**
- 服务器端口未开放
- Webhook服务器未启动
- URL配置错误

**解决方法：**
```bash
# 1. 检查Webhook服务器
ps aux | grep wechat_webhook

# 2. 检查端口
netstat -tlnp | grep 5001

# 3. 检查防火墙
firewall-cmd --list-ports | grep 5001

# 4. 测试URL
curl "http://43.129.17.66:5001/wechat/callback"
```

### 问题2：无法发送消息

**可能原因：**
- 配置信息填写错误
- access_token获取失败
- 应用未授权

**解决方法：**
```bash
# 检查配置
cat config/config.yaml | grep -A 10 wechat_work:

# 测试获取token
curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=YOUR_CORPID&corpsecret=YOUR_SECRET"

# 查看日志
tail -f logs/sentiment_monitor.log | grep 企业微信
```

### 问题3：无法接收消息

**可能原因：**
- 回调URL配置错误
- Token或EncodingAESKey配置错误
- 消息加密解密失败

**解决方法：**
```bash
# 1. 查看Webhook日志
tail -f logs/webhook.log | grep "收到消息"

# 2. 检查配置
cat config/config.yaml | grep -E "token|encoding_aes_key"

# 3. 重启Webhook服务器
./stop_webhook.sh
./start_webhook.sh
```

### 问题4：规则提取失败

**可能原因：**
- 反馈文本格式不对
- 数据库连接失败
- 规则保存失败

**解决方法：**
```bash
# 1. 查看Webhook日志
tail -f logs/webhook.log | grep "提取规则"

# 2. 检查数据库
sqlite3 data/processed_emails.db "SELECT * FROM feedback_rules ORDER BY created_at DESC LIMIT 5;"

# 3. 测试反馈解析
python3 -c "
import re
text = \"误报，这是正常的医疗新闻，排除关键词：收费、价格\"
print(re.findall(r'[“"《](.+?)[”"》]', text))
"
```

---

## ✅ 配置检查清单

完成配置后，请确认：

- [ ] 已创建企业微信应用
- [ ] 已记录CorpId、AgentId、Secret
- [ ] 已配置接收消息回调URL
- [ ] 已生成Token和EncodingAESKey
- [ ] 已修改config.yaml配置文件
- [ ] 已开放服务器5001端口
- [ ] 已启动Webhook服务器
- [ ] URL验证成功
- [ ] 测试消息发送成功
- [ ] 测试按钮反馈成功
- [ ] 测试文本回复成功

---

## 🎉 配置完成

配置完成后，你的系统将具备：

- ✅ 企业微信应用消息（支持按钮）
- ✅ 接收用户反馈
- ✅ 自动提取规则
- ✅ Few-shot学习
- ✅ 持续优化判断

开始使用吧！🚀
