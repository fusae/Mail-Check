# 🚀 舆情监控系统 - 快速启动指南

## 📋 当前状态

✅ **所有组件已就绪**
- 配置文件已创建
- Python依赖已安装
- Playwright浏览器已安装
- 智谱AI连接成功
- Gmail连接成功

---

## 🎯 系统功能

1. **自动监控Gmail**：每5分钟检查新邮件
2. **提取舆情链接**：从邮件中提取token
3. **获取舆情数据**：访问舆情网站获取详情
4. **AI智能判断**：使用智谱AI判断是否负面
5. **控制台输出**：发现负面舆情时立即显示

---

## 📂 项目结构

```
Mail_Check/
├── config/
│   ├── config.yaml          # ⚙️ 配置文件（Gmail、AI等）
│   └── hospitals.txt       # 医院名单（备用）
├── src/
│   ├── email_monitor.py     # 📧 邮件监控
│   ├── link_extractor.py    # 🔗 链接提取
│   ├── content_fetcher.py   # 📊 内容获取
│   ├── sentiment_analyzer.py # 🤖 AI分析
│   └── main.py            # 🎬 主程序
├── logs/
│   └── sentiment_monitor.log # 📝 日志文件
├── data/
│   └── processed_emails.db    # 💾 数据库
├── test_system.sh        # 🔧 系统测试脚本
├── run.sh               # ▶️ 启动脚本
└── 使用指南.md          # 📖 本文件
```

---

## 🚀 快速启动

### 方法1：使用启动脚本（推荐）

```bash
./run.sh
```

脚本会自动：
1. 激活虚拟环境
2. 检查依赖
3. 安装Playwright浏览器
4. 启动主程序

服务器部署及 Playwright 依赖/镜像源配置请参考 `部署指南.md`。

### 方法2：手动启动

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 运行主程序
cd src
python main.py
```

### 方法3：后台运行

```bash
# 使用nohup后台运行
nohup bash run.sh > output.log 2>&1 &

# 查看运行日志
tail -f logs/sentiment_monitor.log
```

---

## 🧪 测试系统

运行测试脚本检查所有组件：

```bash
./test_system.sh
```

预期输出：
```
✓ 配置文件存在
✓ Python模块可用
✓ Chromium浏览器可用
✓ 智谱AI连接成功
✓ Gmail连接成功
找到 0 封新邮件
```

---

## 📊 运行效果

### 正常运行时的输出

```
2026-01-14 16:50:00 - __main__ - INFO - 开始监控，检查间隔: 300秒
2026-01-14 16:50:05 - email_monitor - INFO - 成功连接到Gmail: tengdong2023@gmail.com
2026-01-14 16:50:06 - email_monitor - INFO - 找到 0 封新邮件
2026-01-14 16:50:06 - email_monitor - INFO - 已断开Gmail连接
2026-01-14 16:50:06 - __main__ - INFO - 等待 300 秒后继续...
```

### 发现负面舆情时的输出

```
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
⚠️ 发现负面舆情！
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

医院: XX市第一人民医院
来源: 抖音
标题: 网红疑患性病病历流传
内容摘要: 医院XX市第一人民医院的病历在网络流传...
AI判断: 医疗隐私泄露，对医院声誉造成负面影响
严重程度: high

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```

---

## 🔍 查看日志

### 实时查看日志

```bash
tail -f logs/sentiment_monitor.log
```

### 查看历史日志

```bash
# 查看最后100行
tail -100 logs/sentiment_monitor.log

# 搜索错误
grep "ERROR" logs/sentiment_monitor.log
```

---

## 💾 数据库查询

### 查看已处理的邮件

```bash
sqlite3 data/processed_emails.db "SELECT * FROM processed_emails ORDER BY processed_at DESC LIMIT 10;"
```

### 查看负面舆情记录

```bash
sqlite3 data/processed_emails.db "SELECT * FROM negative_sentiments ORDER BY processed_at DESC;"
```

---

## ⚙️ 修改配置

编辑 `config/config.yaml`：

### 修改检查间隔

```yaml
runtime:
  check_interval: 600  # 改为10分钟检查一次
```

### 修改日志级别

```yaml
runtime:
  log_level: "DEBUG"  # 更详细的日志
```

### 修改AI参数

```yaml
ai:
  temperature: 0.5  # 增加随机性
  max_tokens: 800   # 增加输出长度
```

---

## 🧩 反馈链接功能

### 功能说明
当系统发现负面舆情并推送通知时，消息中会包含一个反馈链接，供用户确认或误判：

- **误判舆情**：标记为误报，删除负面舆情记录，可补充说明
- **确认负面**：确认舆情为负面，保留记录，可补充说明

### 配置反馈服务
在 `config/config.yaml` 中配置（位于 `runtime.feedback`）：

```yaml
runtime:
  feedback:
    link_base_url: "http://localhost:5002"      # 反馈服务地址
    link_secret: "your_secret_key_here"           # 签名密钥
    link_expiry_seconds: 86400                     # 链接有效期（秒，默认1天）
```

### 启动反馈服务

**前台运行：**
```bash
source venv/bin/activate
python3 src/feedback_web_server.py
```

**后台运行：**
```bash
source venv/bin/activate
nohup python3 src/feedback_web_server.py > logs/feedback_web.log 2>&1 &
echo $! > feedback_web.pid
```

**查看反馈服务日志：**
```bash
tail -f logs/feedback_web.log
```

**停止反馈服务：**
```bash
kill $(cat feedback_web.pid)
```

### 数据说明
- 打开反馈链接查看舆情详情：不写入数据库
- 点击提交按钮：会在 `sentiment_feedback` 表保存反馈记录
- 误判舆情：会从 `negative_sentiments` 表删除该记录

### 测试反馈链接
```bash
# 生成测试链接（无需数据库记录）
source venv/bin/activate
python3 -c "
import hashlib
import hmac
import time

secret = '配置中的link_secret'
sentiment_id = 'test_' + str(int(time.time()))
ts = int(time.time())
sig = hmac.new(secret.encode(), f'{sentiment_id}:{ts}'.encode(), hashlib.sha256).hexdigest()
print(f'http://localhost:5002/feedback?sentiment_id={sentiment_id}&ts={ts}&sig={sig}')
"
```

---

## 🛠️ 故障排查

### 问题1：Gmail连接失败

**错误**: `连接Gmail失败`

**解决**:
1. 检查应用专用密码是否正确
2. 确保Gmail开启了IMAP
3. 尝试重新生成应用专用密码

### 问题2：提取不到舆情ID

**错误**: `未提取到舆情ID`

**解决**:
1. 检查网络连接
2. 查看日志中的错误信息
3. 手动访问舆情链接确认token有效

### 问题3：AI分析失败

**错误**: `AI分析失败`

**解决**:
1. 检查API Key是否有效
2. 确认智谱AI账号余额
3. 查看API返回的错误信息

### 问题4：浏览器无法启动

**错误**: `浏览器启动失败`

**解决**:
```bash
# 重新安装浏览器
source venv/bin/activate
playwright install chromium
```

---

## 📱 手机通知（后续开发）

当前版本只输出到控制台。后续将添加：

- [ ] 阿里云语音通知
- [ ] 腾讯云语音通知
- [ ] 短信通知
- [ ] 微信通知

---

## 💡 使用技巧

### 1. 测试邮件

如果你想测试系统但不发送真实通知：

1. 在Gmail中创建测试邮件
2. 手动发送到自己的邮箱
3. 确保邮件主题匹配 `新增.*条舆情信息`

### 2. 调试模式

修改配置文件开启详细日志：

```yaml
runtime:
  log_level: "DEBUG"
```

### 3. 停止程序

在运行中按 `Ctrl+C` 停止程序

---

## 📞 技术支持

如有问题：

1. 查看日志文件：`logs/sentiment_monitor.log`
2. 运行测试脚本：`./test_system.sh`
3. 检查配置文件：`config/config.yaml`

---

## ✅ 验证清单

- [ ] 所有Python依赖已安装
- [ ] Playwright浏览器已安装
- [ ] 配置文件已正确填写
- [ ] 测试脚本全部通过
- [ ] Gmail连接成功
- [ ] AI连接成功
- [ ] 程序可以正常启动

---

## 🎉 开始使用

一切就绪后，运行：

```bash
./run.sh
```

系统将开始自动监控舆情！
