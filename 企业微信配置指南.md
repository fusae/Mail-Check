# 企业微信应用配置指南

## 📋 前置准备

1. ✅ 已有企业微信账号
2. ✅ 有管理员权限（或能创建应用）
3. ✅ 服务器有公网IP（43.129.17.66）
4. ✅ 已完成代码部署

---

## 🚀 配置步骤

### 第一步：创建企业应用

1. 登录企业微信管理后台
   - 访问：https://work.weixin.qq.com
   - 使用企业微信管理员账号登录

2. 进入应用管理
   - 点击顶部「应用管理」
   - 选择「应用」
   - 点击「创建应用」

3. 填写应用信息
   - **应用名称**：舆情监控助手
   - **应用简介**：AI舆情监控和反馈系统
   - **应用Logo**：上传图标（可选）

4. 设置可见范围
   - 选择需要接收通知的群组/成员
   - 建议选择「@所有人」

5. 创建完成后，记录以下信息：
   - **AgentId**：应用ID（例如：123456）
   - **Secret**：应用密钥（例如：xxx-xxx-xxx）

### 第二步：获取企业ID

1. 在企业微信管理后台
2. 点击右上角「企业信息」
3. 记录 **企业ID**（CorpId）
   - 格式：wwxxxxxxxxxx

### 第三步：配置接收消息

1. 进入应用详情
   - 找到刚才创建的「舆情监控助手」应用
   - 点击进入

2. 配置接收消息
   - 点击「接收消息」
   - 启用API接收

3. 填写回调URL
   - **URL**：`https://43.129.17.66:5001/wechat/callback`
   - 点击「生成Token」→ 记录Token
   - 点击「生成EncodingAESKey」→ 记录EncodingAESKey

4. 保存配置

### 第四步：修改配置文件

编辑 `config/config.yaml`：

```yaml
notification:
  provider: "wechat_work"

  # 企业微信应用配置
  wechat_work:
    corp_id: "ww1234567890abcdef"           # 企业ID
    agent_id: "123456"                     # 应用AgentID
    secret: "xxx-xxx-xxx"                 # 应用Secret
    token: "abc123xyz"                     # 验证Token
    encoding_aes_key: "base64_encoded_key"  # 加密密钥
    to_user: "@all"                        # 接收人，@all表示所有人

    # 群机器人配置（备用）
    # webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
```

**替换为你的实际值：**
- `corp_id`: 你的企业ID
- `agent_id`: 应用的AgentID
- `secret`: 应用的Secret
- `token`: 接收消息时生成的Token
- `encoding_aes_key`: 接收消息时生成的EncodingAESKey

### 第五步：开放服务器端口

在服务器上执行：

```bash
# 开放5001端口（Webhook服务器）
firewall-cmd --zone=public --add-port=5001/tcp --permanent
firewall-cmd --reload

# 或使用iptables
iptables -I INPUT -p tcp --dport 5001 -j ACCEPT
service iptables save
```

如果使用腾讯云安全组：
1. 登录腾讯云控制台
2. 进入「云服务器」→「安全组」
3. 添加入站规则：
   - 协议：TCP
   - 端口：5001
   - 来源：0.0.0.0/0

### 第六步：启动Webhook服务器

```bash
cd /root/mail_check
./start_webhook.sh
```

### 第七步：验证配置

1. 在企业微信后台，点击「保存」配置
2. 系统会自动验证URL是否可访问
3. 如果验证成功，显示「验证成功」
4. 如果失败，检查：
   - 服务器端口是否开放
   - Webhook服务器是否启动
   - URL是否正确

---

## 🎯 测试通知

### 方法1：手动触发

```bash
cd /root/mail_check

# 发送测试通知
python3 -c "
import sys
sys.path.insert(0, 'src')
from wechat_api import WeChatWorkAPI
import yaml

with open('config/config.yaml', 'r') as f:
    config = yaml.safe_load(f)

wechat = WeChatWorkAPI(config['wechat_work'])
result = wechat.send_text('@all', '企业微信配置测试！')
print(result)
"
```

### 方法2：通过Webhook

```bash
# 查看Webhook日志
tail -f logs/webhook.log
```

---

## 📊 完整配置示例

```yaml
notification:
  provider: "wechat_work"

  wechat_work:
    # 企业应用配置（支持反馈）
    corp_id: "ww1234567890abcdef"
    agent_id: "123456"
    secret: "xxx-xxx-xxx-xxx-xxx-xxx-xxx-xxx"
    token: "abc123xyz"
    encoding_aes_key: "base64_encoded_key_here"
    to_user: "@all"

    # 群机器人配置（备用，不支持反馈）
    # webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
```

---

## 🔧 故障排查

### 问题1：URL验证失败

**可能原因：**
1. 服务器端口未开放
2. Webhook服务器未启动
3. URL配置错误

**解决方法：**
```bash
# 检查Webhook服务器是否启动
ps aux | grep webhook

# 检查端口是否监听
netstat -tlnp | grep 5001

# 检查防火墙
firewall-cmd --list-all

# 查看Webhook日志
tail -f logs/webhook.log
```

### 问题2：无法发送消息

**可能原因：**
1. corp_id、agent_id、secret 配置错误
2. access_token 获取失败
3. 网络问题

**解决方法：**
```bash
# 测试API连接
curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=your_corp_id&corpsecret=your_secret"

# 查看主程序日志
tail -f logs/sentiment_monitor.log
```

### 问题3：无法接收消息

**可能原因：**
1. 回调URL配置错误
2. token或encoding_aes_key配置错误
3. 消息加密解密失败

**解决方法：**
```bash
# 查看Webhook日志
tail -f logs/webhook.log | grep "收到消息"

# 检查配置
cat config/config.yaml | grep -A 10 wechat_work
```

---

## 📱 使用反馈功能

配置完成后，你可以：

### 发送负面舆情通知
AI会自动发送企业微信通知，格式如下：

```
### ⚠️ 发现医院负面舆情

> **医院：** 东莞市第九人民医院
> **来源：** 抖音
> **AI判断：** 医疗隐私泄露，严重程度: high

**内容摘要：**
医院的病历在网络流传，引起患者不满...

---
> 💡 **AI自动判断，可能误报**
>
> **反馈方式：**
> - 直接回复本消息即可反馈
> - 例：`误报，这是正常的XX新闻`
> - 例：`确认，确实是负面`
```

### 提交反馈
1. 在企业微信中，点击通知消息
2. 直接回复：
   - `误报，这是正常的医疗新闻`
   - `确认，确实是负面舆情`
3. 系统会自动保存反馈并用于AI优化

---

## ✅ 配置检查清单

- [ ] 已创建企业微信应用
- [ ] 已记录CorpId、AgentId、Secret
- [ ] 已配置接收消息回调URL
- [ ] 已修改config.yaml配置
- [ ] 已开放服务器5001端口
- [ ] 已启动Webhook服务器
- [ ] URL验证成功
- [ ] 测试消息发送成功

---

## 🎉 配置完成

配置完成后，你的系统将具备：
- ✅ 自动发送企业微信通知
- ✅ 接收用户反馈
- ✅ 保存反馈到数据库
- ✅ AI学习反馈优化判断

开始使用吧！🚀
