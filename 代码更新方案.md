# 🔄 代码更新方案对比

## 📋 三种更新方案

### 方案一：rsync 直接同步（推荐个人使用）

**适合场景：**
- ✅ 个人项目，单人开发
- ✅ 本地修改后立即部署
- ✅ 需要快速测试代码
- ✅ 不想使用Git管理代码

**优点：**
- 🚀 超级简单，一条命令完成
- 🚀 即时同步，无延迟
- 🚀 不需要Git知识
- 🚀 可以选择性同步文件

**缺点：**
- ⚠️ 没有版本控制
- ⚠️ 容易覆盖服务器上的文件
- ⚠️ 不适合团队协作

**使用方法：**

```bash
# 1. 编辑脚本中的服务器配置
vim sync.sh

# 修改这些配置：
SERVER_USER="your_username"
SERVER_HOST="your.server.com"
SERVER_PATH="/home/yourname/Mail_Check"

# 2. 同步代码
./sync.sh

# 3. 脚本会询问是否重启服务
```

**高级用法：**

```bash
# 只同步特定文件
rsync -avz src/main.py user@server:/path/to/Mail_Check/src/

# 排除某些文件
rsync -avz --exclude 'test_*' \
  --exclude 'dev_*' \
  ./ user@server:/path/to/Mail_Check/

# 查看将要同步的文件（不实际同步）
rsync -avz --dry-run ./ user@server:/path/to/Mail_Check/
```

---

### 方案二：Git + 自动化更新（推荐团队使用）

**适合场景：**
- ✅ 团队协作开发
- ✅ 需要版本控制
- ✅ 需要回滚功能
- ✅ 多环境部署（开发/测试/生产）

**优点：**
- 📦 完整的版本历史
- 🔄 方便回滚到任意版本
- 👥 支持多人协作
- 🌍 支持多分支开发
- 📊 可以查看提交历史

**缺点：**
- 📚 需要Git基础知识
- 🌐 需要远程仓库（GitHub/GitLab等）
- ⏱️ 稍微复杂一些

**使用方法：**

#### 初始化Git仓库

```bash
# 在项目根目录
cd /path/to/Mail_Check

# 初始化Git
git init

# 创建.gitignore
cat > .gitignore << 'EOF'
venv/
__pycache__/
*.pyc
logs/*.log
data/*.db
data/*.db-*
.DS_Store
*.pyc
EOF

# 提交初始代码
git add .
git commit -m "Initial commit: 舆情监控系统"

# 添加远程仓库（需要在GitHub/GitLab创建仓库）
git remote add origin https://github.com/yourusername/Mail_Check.git

# 推送到远程仓库
git push -u origin main
```

#### 更新代码

```bash
# 1. 修改代码后提交
vim src/main.py
git add .
git commit -m "fix: 修复邮件解析bug"

# 2. 推送到远程仓库
git push

# 3. 在服务器上更新
./update.sh
```

#### 在服务器上拉取更新

```bash
# 第一次配置
ssh user@server
cd /path/to/Mail_Check
git clone https://github.com/yourusername/Mail_Check.git .

# 之后每次更新
./auto_update.sh
```

---

### 方案三：混合方案（推荐生产环境）

**适合场景：**
- ✅ 本地使用Git管理代码
- ✅ 服务器自动拉取更新
- ✅ 需要CI/CD集成
- ✅ 需要自动化部署

**工作流程：**

```
本地开发 -> Git提交 -> 远程仓库 -> 服务器自动更新
```

**配置自动更新（通过GitHub Webhook）：**

1. **服务器配置：**
```bash
# 在服务器上启动一个简单的Webhook监听服务
# 使用Python Flask实现

cat > webhook_server.py << 'EOF'
from flask import Flask, request, jsonify
import subprocess
import os

app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.json
    
    # 验证GitHub密钥（可选）
    # secret = request.headers.get('X-Hub-Signature')
    
    if data.get('ref') == 'refs/heads/main':
        # 执行更新脚本
        subprocess.Popen(['bash', 'auto_update.sh'])
        return jsonify({'status': 'success', 'message': 'Update triggered'})
    
    return jsonify({'status': 'ignored', 'message': 'Not main branch'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
EOF

# 安装Flask
source venv/bin/activate
pip install flask

# 启动Webhook服务
nohup python webhook_server.py > logs/webhook.log 2>&1 &
```

2. **GitHub配置：**
   - 进入仓库的 Settings -> Webhooks
   - 点击 "Add webhook"
   - Payload URL: `http://your-server-ip:5000/webhook`
   - Content type: `application/json`
   - 保存配置

3. **自动更新：**
   - 每次你push代码到GitHub
   - 服务器会自动接收到Webhook
   - 自动执行 `auto_update.sh` 更新代码

---

## 📊 方案对比总结

| 特性 | rsync同步 | Git+更新 | 混合方案 |
|-----|---------|---------|---------|
| 简单度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| 速度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| 版本控制 | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 团队协作 | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 自动化 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 回滚能力 | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 学习成本 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |

---

## 🎯 推荐使用策略

### 个人项目
```bash
# 使用 rsync 方案
./sync.sh
```

### 小团队项目
```bash
# 使用 Git 方案
git add .
git commit -m "更新功能"
git push
./update.sh
```

### 生产环境
```bash
# 使用混合方案 + Webhook
git add .
git commit -m "生产更新"
git push
# 服务器自动更新
```

---

## 🚀 快速开始

### 第一步：选择方案

根据你的情况选择：

- **个人使用，不想用Git** → 方案一：rsync同步
- **团队协作，需要版本控制** → 方案二：Git更新
- **生产环境，需要自动化** → 方案三：混合方案

### 第二步：配置脚本

根据选择的方案，修改对应的配置文件：

**rsync方案：**
```bash
vim sync.sh
# 修改 SERVER_USER, SERVER_HOST, SERVER_PATH
```

**Git方案：**
```bash
# 初始化Git仓库
git init
git add .
git commit -m "Initial commit"
git remote add origin <your-repo-url>
git push -u origin main
```

**混合方案：**
```bash
# 需要配置GitHub Webhook
# 参考上面的"混合方案"章节
```

### 第三步：测试更新

```bash
# 修改一个文件
vim src/main.py

# 测试更新
./sync.sh    # 或 ./update.sh

# 验证更新
ssh user@server "cd /path/to/Mail_Check && ./status.sh"
```

---

## 💡 最佳实践

### 1. 开发前先更新
```bash
# 确保本地是最新代码
git pull
```

### 2. 小步提交，频繁更新
```bash
# 每完成一个小功能就提交
git add .
git commit -m "feat: 添加新的通知方式"
git push
```

### 3. 使用有意义的提交信息
```bash
# 好的提交信息
git commit -m "fix: 修复邮件解析bug，支持163邮箱"

# 不好的提交信息
git commit -m "update"
```

### 4. 更新前测试
```bash
# 在本地测试
python src/main.py

# 确认无误后再更新
./update.sh
```

### 5. 保留配置文件
```bash
# 不要覆盖配置文件
rsync --exclude 'config/config.yaml' ./ user@server:/path/to/Mail_Check/
```

---

## 🎉 总结

对于你的情况，我推荐：

**阶段一（现在）：使用 rsync 方案**
- 简单快速，立即开始
- 适合个人开发

**阶段二（后续）：升级到 Git 方案**
- 如果需要版本控制
- 如果需要回滚功能

**阶段三（生产）：混合方案**
- 如果有多台服务器
- 如果需要自动化部署

从最简单的方案开始，根据需求逐步升级！🚀