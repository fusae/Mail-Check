# 🚀 服务器部署指南

## 📋 前置准备

### 1. 服务器要求
- **操作系统**: Ubuntu 20.04+, Debian 10+, CentOS 7+, 或类似的Linux系统
- **Python版本**: Python 3.8 或更高版本
- **内存**: 至少 1GB RAM
- **磁盘**: 至少 2GB 可用空间
- **网络**: 需要访问互联网（用于发送通知和获取舆情数据）

### 2. 准备配置文件
在部署前，确保已经准备好以下配置信息：
- 邮箱地址和应用专用密码
- 智谱AI的API密钥
- 通知服务的相关配置（企业微信/Telegram等）

---

## 🚀 一键部署流程

### 第一步：上传代码到服务器

**方法1: 使用 rsync（推荐）**
```bash
# 在本地机器上执行
rsync -avz --exclude 'venv' \
  --exclude '__pycache__' \
  --exclude '*.pyc' \
  --exclude 'logs/*.log' \
  --exclude 'data/*.db' \
  --exclude '.DS_Store' \
  ./ user@your-server:/path/to/Mail_Check/
```

**方法2: 使用 SCP**
```bash
# 打包项目文件
tar -czf mail_check.tar.gz --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='logs' --exclude='data' .

# 上传到服务器
scp mail_check.tar.gz user@your-server:/path/to/

# 在服务器上解压
ssh user@your-server
cd /path/to
tar -xzf mail_check.tar.gz
```

**方法3: 使用 Git（推荐）**
```bash
# 在服务器上克隆代码
git clone https://github.com/yourusername/Mail_Check.git
cd Mail_Check
```

---

### 第二步：配置系统

```bash
# 1. 连接到服务器
ssh user@your-server

# 2. 进入项目目录
cd /path/to/Mail_Check

# 3. 确保部署脚本有执行权限
chmod +x deploy.sh run.sh stop.sh status.sh

# 4. 编辑配置文件（重要！）
vim config/config.yaml
```

**关键配置项：**
```yaml
email:
  imap_server: "imap.qq.com"
  imap_port: 993
  email_address: "your@qq.com"
  app_password: "your_app_password"  # 应用专用密码
  
ai:
  api_key: "your_zhipu_api_key"       # 智谱AI密钥
  
notification:
  provider: "wechat_work"             # 或 "telegram"
  wechat_work:
    webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_WEBHOOK_KEY"
  telegram:
    bot_token: "your_bot_token"
    chat_id: "your_chat_id"
```

---

### 第三步：执行一键部署

```bash
# 执行部署脚本
./deploy.sh
```

**部署脚本会自动完成以下步骤：**
1. ✅ 检查操作系统和Python版本
2. ✅ 安装系统依赖（包括Playwright浏览器依赖）
3. ✅ 创建Python虚拟环境
4. ✅ 安装Python依赖包
5. ✅ 安装Playwright浏览器
6. ✅ 检查配置文件
7. ✅ 创建必要的目录和脚本
8. ✅ 设置文件权限

**预期输出：**
```
==================================================================
             Mail_Check 舆情监控系统 一键部署
==================================================================

[INFO] 检测到操作系统: Ubuntu 22.04
[INFO] 当前Python版本: 3.10.12
[SUCCESS] Python版本满足要求 (>= 3.8)
[INFO] 安装系统依赖...
[SUCCESS] 系统依赖安装完成
[INFO] 创建Python虚拟环境...
[SUCCESS] 虚拟环境创建完成
[INFO] 安装Python依赖包...
[SUCCESS] Python依赖安装完成
[INFO] 安装Playwright浏览器...
[SUCCESS] Playwright浏览器安装完成
[INFO] 检查配置文件...
[SUCCESS] 配置文件检查完成
[SUCCESS] 停止脚本创建完成
[SUCCESS] 状态脚本创建完成
[SUCCESS] 权限设置完成

==================================================================
[SUCCESS] 部署完成！
==================================================================

常用命令:
  启动服务: ./run.sh
  停止服务: ./stop.sh
  查看状态: ./status.sh
  查看日志: tail -f logs/sentiment_monitor.log
```

---

## 📮 API/反馈服务部署

反馈服务用于收集用户对舆情的反馈（确认/误判）。

### 配置反馈服务
在 `config/config.yaml` 中配置（位于 `feedback`）：

```yaml
feedback:
  link_base_url: "http://<服务器地址>:<API端口>/feedback"  # 修改为你的域名/端口（端口以配置为准）
  link_secret: "your_secret_key_here"                      # 签名密钥，请修改为随机字符串
```

### 启动 API/反馈服务

**前台运行（测试）：**
```bash
source venv/bin/activate
python3 src/api_server.py
```

**后台运行（生产）：**
```bash
source venv/bin/activate
nohup python3 src/api_server.py > logs/api_server.log 2>&1 &
echo $! > api_server.pid
```

### 设置防火墙规则（重要）

如果使用公网域名直连 API 端口，需要开放配置中的 API 端口；如果走 Nginx 反代，则只需开放 80/443。

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow <API端口>/tcp

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=<API端口>/tcp
sudo firewall-cmd --reload
```

**安全建议：**
- 使用 HTTPS 反向代理（Nginx）
- 限制访问来源 IP
- 使用复杂的 `link_secret`

### Web 仪表盘构建（可选）

```bash
cd web
npm install
npm run build
```

### Nginx 反向代理配置（可选）

```nginx
server {
    listen 80;
    server_name your-domain.com;

    root /path/to/Mail_Check/web/dist;
    index index.html;

    location / {
        try_files $uri /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:<API端口>;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /feedback {
        proxy_pass http://127.0.0.1:<API端口>/feedback;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

配置后修改 `config.yaml`：
```yaml
feedback:
  link_base_url: "http://your-domain.com/feedback"
```

---

## 🔄 版本管理和回滚

### 使用 Git 进行版本控制

代码版本通过 Git 管理，回滚非常简单。

### 更新代码

```bash
# 拉取最新代码
git pull origin main
```

### 回滚到上一个版本

**方法1：回退到上一个 commit**
```bash
git reset --hard HEAD~1
```

**方法2：回退到指定 commit**
```bash
# 查看提交历史
git log --oneline -10

# 回滚到指定 commit
git reset --hard <commit-hash>
```

**方法3：使用 rollback.sh 脚本（推荐）**
```bash
./rollback.sh
```

脚本功能：
- 自动列出最近 10 个提交
- 支持代码回滚
- 支持数据库恢复
- 自动停止/重启服务

### 数据库备份（不在 Git 中）

数据库文件不在 Git 仓库中，需要手动备份：

```bash
# 手动备份数据库
cp data/processed_emails.db backups/database_$(date +%Y%m%d).db

# 或使用 rollback.sh 中的备份功能
```

### 更新流程（推荐）

```bash
# 1. 停止服务
./stop_all.sh

# 2. 备份数据库（可选）
cp data/processed_emails.db backups/database_$(date +%Y%m%d).db

# 3. 更新代码
git pull origin main

# 4. 启动服务
./start_all.sh

# 5. 查看状态
./status_all.sh

# 如果有问题，回滚
./rollback.sh
```

---

## 🎮 部署后管理

### 启动服务

**方法1: 前台运行（用于测试）**
```bash
./run.sh
```

**方法2: 后台运行（推荐用于生产）**
```bash
./run.sh --daemon
# 或
./run.sh -d
```

### 停止服务
```bash
./stop.sh
```

### 查看状态
```bash
./status.sh
```

**预期输出：**
```
舆情监控系统状态
==================================================================
进程状态: 运行中
进程ID: 12345
运行时间: 02:15:30
内存使用: 125.5MB

日志文件: logs/sentiment_monitor.log
日志大小: 2.3M

最近5条日志:
2026-01-19 10:30:05 - email_monitor - INFO - 成功连接到Gmail: your@gmail.com
2026-01-19 10:30:06 - email_monitor - INFO - 找到 0 封新邮件
2026-01-19 10:30:06 - email_monitor - INFO - 已断开Gmail连接
2026-01-19 10:30:06 - __main__ - INFO - 等待 300 秒后继续...

==================================================================
数据库: 存在 (大小: 1.2M)
```

### 查看日志
```bash
# 实时查看日志
tail -f logs/sentiment_monitor.log

# 查看最后100行
tail -100 logs/sentiment_monitor.log

# 搜索错误日志
grep "ERROR" logs/sentiment_monitor.log

# 搜索负面舆情
grep "发现负面舆情" logs/sentiment_monitor.log
```

---

## 🔧 常见问题解决

### 问题1: 部署脚本无法执行
**症状**: `bash: ./deploy.sh: Permission denied`

**解决**:
```bash
chmod +x deploy.sh run.sh stop.sh status.sh
```

### 问题2: Python版本不满足要求
**症状**: `[ERROR] Python版本过低，需要 Python 3.8 或更高版本`

**解决**:
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3.10 python3.10-venv

# CentOS/RHEL
sudo yum install python3.10
```

### 问题3: 系统依赖安装失败
**症状**: `apt-get: command not found` 或 `yum: command not found`

**解决**: 
- 检查你的Linux发行版，手动安装对应的系统包管理工具
- 参考上面的"系统依赖安装"章节

### 问题4: Playwright安装失败
**症状**: `[ERROR] Playwright浏览器安装失败`

**解决**:
```bash
# 手动安装
source venv/bin/activate

# 下载浏览器（确保用运行服务的同一用户执行）
playwright install chromium

# 如果需要走镜像源（可选）
PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright/ \
  playwright install chromium

# 依赖安装（Ubuntu/Debian 可用）
playwright install-deps chromium
```

**TencentOS/CentOS 等无 apt-get 环境：**
```bash
# 手动安装常见依赖（含 libasound.so.2 对应的 alsa-lib）
yum install -y alsa-lib \
  atk at-spi2-atk cups-libs libdrm libgbm libxkbcommon \
  libX11 libXcomposite libXdamage libXfixes libXrandr libXcursor libXext libXi libXtst \
  nss pango cairo gtk3

# 然后再下载浏览器
source venv/bin/activate
playwright install chromium
```

### 问题5: 配置文件错误
**症状**: `[ERROR] 配置文件不存在: config/config.yaml`

**解决**:
```bash
# 检查配置文件是否存在
ls -la config/config.yaml

# 如果不存在，需要创建配置文件
cp config/config.yaml.example config/config.yaml
vim config/config.yaml
```

### 问题6: 服务启动失败
**症状**: 启动后立即停止

**解决**:
```bash
# 查看启动日志
cat logs/startup.log

# 或前台运行查看详细错误
./run.sh
```

### 问题7: 权限问题
**症状**: `[ERROR] Permission denied`

**解决**:
```bash
# 设置正确的文件权限
chmod -R 755 .
chmod +x deploy.sh run.sh stop.sh status.sh
```

---

## 📊 监控和维护

### 设置定时重启（可选）
```bash
# 编辑crontab
crontab -e

# 添加每天凌晨3点重启
0 3 * * * cd /path/to/Mail_Check && ./stop.sh && sleep 5 && ./run.sh --daemon
```

### 设置日志轮转（可选）
```bash
# 创建日志轮转配置
sudo vim /etc/logrotate.d/mail_check

# 添加以下内容
/path/to/Mail_Check/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
```

### 数据库备份（推荐）
```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/path/to/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份数据库
cp data/processed_emails.db $BACKUP_DIR/processed_emails_$DATE.db

# 保留最近7天的备份
find $BACKUP_DIR -name "processed_emails_*.db" -mtime +7 -delete

echo "数据库备份完成: $BACKUP_DIR/processed_emails_$DATE.db"
EOF

chmod +x backup.sh

# 添加到crontab，每天备份一次
crontab -e
# 添加: 0 4 * * * /path/to/Mail_Check/backup.sh
```

---

## 🔒 安全建议

### 1. 修改默认配置文件权限
```bash
chmod 600 config/config.yaml
```

### 2. 使用防火墙限制访问
```bash
# 如果有Web界面，只允许特定IP访问
sudo ufw allow from your.ip.address to any port 5000
```

### 3. 定期更新系统
```bash
sudo apt-get update && sudo apt-get upgrade -y
```

---

## 📞 技术支持

如果遇到其他问题：
1. 查看日志文件：`logs/sentiment_monitor.log`
2. 查看启动日志：`logs/startup.log`
3. 查看系统状态：`./status.sh`
4. 检查配置文件：`config/config.yaml`

---

## ✅ 部署检查清单

部署完成后，请确认以下项目：

**基础环境：**
- [ ] 服务器操作系统符合要求
- [ ] Python版本 >= 3.8
- [ ] Git 仓库已初始化

**依赖安装：**
- [ ] 系统依赖已安装
- [ ] Python虚拟环境已创建
- [ ] Python依赖包已安装
- [ ] Playwright浏览器已安装

**服务运行：**
- [ ] 部署脚本执行无错误
- [ ] 服务可以正常启动
- [ ] 日志正常输出

**功能验证：**
- [ ] 邮箱连接正常
- [ ] AI分析功能正常
- [ ] 通知功能正常
- [ ] 反馈服务正常（端口以配置为准）

**版本管理：**
- [ ] 代码已提交到 Git
- [ ] rollback.sh 脚本可执行
- [ ] 测试过一次 Git 回滚

---

## 🎉 部署成功

部署完成后，你的舆情监控系统将在服务器上稳定运行，自动监控邮箱，发现负面舆情并及时通知你！

**建议：**
- 定期查看日志，确保系统运行正常
- 定期备份数据库
- 及时更新系统和依赖包
- 关注系统资源使用情况

祝你使用愉快！🚀
